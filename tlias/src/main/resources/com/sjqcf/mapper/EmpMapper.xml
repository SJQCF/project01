<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sjqcf.mapper.EmpMapper">
    <select id="list" resultType="com.sjqcf.pojo.Emp">
        select e.*,d.name as deptname from emp e left join dept d on e.dept_id = d.id
        <where>
            <if test = "name != null and name != ''">
                e.name like concat('%',#{name},'%')
            </if>
            <if test = "gender != null">
                and e.gender = #{gender}
            </if>
            <if test = "begin != null and end != null">
                and e.entry_date between #{begin} and #{end}
            </if>
        </where>
        order by e.update_time desc
    </select>

    <delete id = "deleteById">
        delete from emp where id in
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>

    <resultMap id="empResultMap" type="com.sjqcf.pojo.Emp">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="name" property="name"/>
        <result column="gender" property="gender"/>
        <result column="phone" property="phone"/>
        <result column="job" property="job"/>
        <result column="salary" property="salary"/>
        <result column="image" property="image"/>
        <result column="entry_date" property="entryDate"/>
        <result column="dept_id" property="deptId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>

        <collection property="exprList" ofType="com.sjqcf.pojo.EmpExpr">
            <id column="expr_id" property="id"/>
            <result column="emp_id" property="empId"/>
            <result column="begin" property="begin"/>
            <result column="end" property="end"/>
            <result column="company" property="company"/>
            <result column="expr_job" property="job"/>
        </collection>
    </resultMap>

    <select id="findById" resultMap="empResultMap">
        select emp.*,
               emp_expr.id as expr_id,
               emp_expr.emp_id,
               emp_expr.begin,
               emp_expr.end,
               emp_expr.company,
               emp_expr.job as expr_job
        from emp left join emp_expr on emp.id = emp_expr.emp_id
        where emp.id = #{id}
    </select>

    <update id="update">
        update emp
        <set>
            <if test="username != null and username != ''">
                username = #{username},
            </if>
            <if test="password != null">
                password = #{password},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="gender != null">
                gender = #{gender},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="job != null">
                job = #{job},
            </if>
            <if test="salary != null">
                salary = #{salary},
            </if>
            <if test="image != null">
                image = #{image},
            </if>
            <if test="entryDate != null">
                entry_date = #{entryDate},
            </if>
            <if test="deptId != null">
                dept_id = #{deptId},
            </if>
            update_time = #{updateTime}
            where id = #{id}
        </set>
    </update>

    <select id="countEmpJobDate" resultType="java.util.Map">
        select (case when job='1' then '班主任'
                        when job='2' then '讲师'
                        when job='3' then '学工主管'
                        when job='4' then '教研主管'
                        when job='5' then '咨询师'
                        else '其他' end) as job,
            count(*) as date from emp group by job order by date;
    </select>

    <select id="countEmpGenderData" resultType="java.util.Map">
        select
            (case when gender = '1' then '男性员工' else '女性员工' end) as name,
            count(*) as value
        from emp
        group by gender;
    </select>
</mapper>
